@startuml Deployment Diagram - Dockerized Client + Database Architecture

!theme plain
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam dpi 120
skinparam componentFontSize 10
skinparam componentBackgroundColor #E3F2FD
skinparam componentBorderColor #1976D2
skinparam packageBackgroundColor #F3E5F5
skinparam packageBorderColor #7B1FA2
skinparam databaseBackgroundColor #E8F5E9
skinparam databaseBorderColor #2E7D32
skinparam arrowColor #1F2933
skinparam noteBackgroundColor #FFF3CD
skinparam noteBorderColor #856404

node "Customer Browser" as CustomerBrowser
node "Admin Browser" as AdminBrowser

node "Docker Host" {
    frame "docker compose stack" {
        node "web\n(Gunicorn + Flask)" as WebContainer {
            component "Flask Application\n(main.py + blueprints)" as Flask
            component "Returns & Refunds Module\n(services + templates)" as ReturnsModule
            component "Quality Tactics Manager" as QTM
            component "Observability Dashboard\n(/admin/dashboard)" as Dashboard
        }

        node "db\n(PostgreSQL 15)" as DbContainer {
            database "Retail DB\n(core tables + RMA + metrics)" as RetailDB
            artifact "Persistent Volume\npostgres_data" as Volume
        }
    }
}

node "External Services" {
    component "Mock Payment Gateway" as PaymentGateway
    component "Partner APIs" as PartnerAPIs
}

node "Monitoring Tooling" {
    component "Structured Logs" as Logs
    component "Metrics Snapshot\n(/admin/metrics)" as MetricsEndpoint
}

CustomerBrowser --> Flask : HTTPS\nstorefront & checkout
AdminBrowser --> Dashboard : HTTPS\nadmin console
Flask --> ReturnsModule : invoke RMA workflow
Flask --> QTM : apply tactics
QTM --> RetailDB : read/write\nCircuitBreakerState\nOrderQueue
ReturnsModule --> RetailDB : persist RMA entities
Dashboard --> MetricsEndpoint : poll JSON
Flask --> RetailDB : SQLAlchemy ORM
RetailDB --> Volume : data files

Flask --> PaymentGateway : Refund / charge
Flask --> PartnerAPIs : Catalog sync
Logs <- Flask : structured JSON
MetricsEndpoint <- QTM : counters/histograms/events

note right of WebContainer
  Flask container bundles:
  - Gunicorn workers
  - Returns blueprint + services
  - Observability middleware
  - Quality tactics manager
end note

note right of DbContainer
  Postgres container bootstraps via
  `db/init.sql`, migrations, and
  demo seeds. Volumes keep state
  between compose restarts.
end note

note right of Dashboard
  Admin dashboard surfaces:
  - RMA rate & cycle time
  - Scenario A.1 and P.1 KPIs
  - HTTP latency & recent events
  - Metrics bucketed using Config.DEFAULT_TIMEZONE
end note

@enduml
