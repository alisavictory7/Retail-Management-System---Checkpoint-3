@startuml System Sequence Diagram - End-to-End Returns Workflow

!theme plain
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 1
skinparam roundcorner 15
skinparam maxmessagesize 50
skinparam dpi 120
skinparam participantFontSize 10
skinparam participantBackgroundColor #E3F2FD
skinparam participantBorderColor #1976D2
skinparam actorBackgroundColor #FFEBEE
skinparam actorBorderColor #D32F2F
skinparam noteBackgroundColor #FFF3CD
skinparam noteBorderColor #856404

actor "Customer" as Customer
participant "Browser" as Browser
participant "Flask App" as Flask
participant "Returns Service" as ReturnsService
participant "Admin Portal" as AdminPortal
participant "Payment Service\n(Circuit Breaker)" as PaymentService
participant "Inventory Service" as Inventory

== RMA Request ==
Customer -> Browser: Open /returns
Browser -> Flask: GET /returns
Flask -> ReturnsService: fetch_completed_sales(user)
ReturnsService --> Flask: sales + prior RMAs
Flask --> Browser: Render RMA form

Customer -> Browser: Submit return (items + photos)
Browser -> Flask: POST /returns/request
Flask -> ReturnsService: create_return_request(payload)
ReturnsService -> ReturnsService: validate policy window\ncheck item quantities
ReturnsService --> Flask: RMA created (PENDING_AUTHORIZATION)
Flask --> Browser: Flash success + RMA number

== Authorization & Logistics ==
actor "Store Admin" as Admin
Admin -> AdminPortal: Review /admin/returns
AdminPortal -> ReturnsService: authorize_return(rma_id, approve=true)
ReturnsService --> AdminPortal: status AUTHORIZED + RMA number

Customer -> Browser: Provide shipment tracking
Browser -> Flask: POST /returns/shipment
Flask -> ReturnsService: record_shipment(rma_id, carrier, tracking)
ReturnsService --> Flask: status IN_TRANSIT

Admin -> AdminPortal: Mark package received
AdminPortal -> ReturnsService: mark_received(rma_id)
ReturnsService --> AdminPortal: status RECEIVED

== Inspection ==
Admin -> AdminPortal: Record inspection result
AdminPortal -> ReturnsService: record_inspection(rma_id, APPROVED)
ReturnsService --> AdminPortal: status APPROVED

== Refund Execution ==
alt Manual method (cash / store credit)
    AdminPortal -> ReturnsService: initiate_refund(rma_id, method=manual)
    ReturnsService -> Inventory: apply_return_stock(items)
    Inventory --> ReturnsService: stock replenished
    ReturnsService --> AdminPortal: status REFUNDED + manual reference
else Card / Original method
    AdminPortal -> ReturnsService: initiate_refund(rma_id, method=card/original)
    ReturnsService -> PaymentService: execute_with_circuit_breaker(refund_fn)
    PaymentService -> PaymentService: call mock gateway
    PaymentService --> ReturnsService: refund success + reference
    ReturnsService -> Inventory: apply_return_stock(items)
    Inventory --> ReturnsService: stock replenished
    ReturnsService --> AdminPortal: status REFUNDED + refund details
end

note over PaymentService
  Availability Scenario A.1
  - Circuit breaker emits MTTR metric
  - Orders accepted counter updated
end note

note over ReturnsService
  Stage coverage:
  1) Submit request
  2) Validate & authorize
  3) Record shipment
  4) Inspect
  5) Issue refund & close
end note

AdminPortal --> Admin: Dashboard updated\n(RMA rate, cycle time)
Flask --> Browser: Notify customer via UI/email
Browser --> Customer: RMA closed + refund confirmation

@enduml
